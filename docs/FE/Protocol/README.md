互联网协议入门

## 五层模型
体层"（Physical Layer），最上面的一层叫做"应用层"（Application Layer），中间的三层（自下而上）分别是"链接层"（Link Layer）、"网络层"（Network Layer）和"传输层"（Transport Layer）。越下面的层，越靠近硬件；越上面的层，越靠近用户。

```Mermaid
graph TB
    subgraph OSI参考模型
    b1(应用层 Application) --> b11(表示层) --> b12(会话层) --> b2(传输层 Transport) --> b3(网络层 Network) --> b4(数据链路层 Link) --> b5(物理层 Physical)
    end
    subgraph TCP/IP五层模型
    a1(应用层 Application) --> a2(传输层 Transport) --> a3(网络层 Network) --> a4(数据链路层 Link) --> a5(物理层 Physical)
    end
    b1 --> a1
    b11 --> a1
    b12 --> a1
    b2 --> a2
    b3 --> a3
    b4 --> a4
    b5 --> a5
```









## 即时通信协议
IM: Instant Messaging

### 推送服务

> 轮询方式

客户端不断的查询服务器，检索新内容。这种方式的缺点十分明显，如果轮询频率过快，会大量消耗网络带宽和电池；

> 长连接方式

客户端和服务端维持一条TCP/IP长连接，服务端向客户端push数据。这种方式可以避免轮询方式带来的性能问题，但是长连接依然会带来耗能问题。目前苹果的APNS和谷歌的GCM都是基于此方案来实现推送服务的；

> SMS方式

当服务端有新内容的时候，会发送一条类似短信的指令传给客户端，客户端收到后从服务端下载新内容。由于运营商并没有免费开放这种指令，使用需要向运营商缴纳部分费用，所以并没有大量运用起来，但是这种方式非常的高效和及时。


> IMPP即时信息和空间协议

Instant Messaging And PresenceProtocol

> PRIM空间和即时信息协议

Presence and Instant Messaging Protocol
> SIP回话发起协议

Session Initialion Protocol
SIMPLE(SIP for Instant Messaging and Presence Leveraging Extensiong,SIP即时消息和表示扩展协议,即SIP的扩展协议

> XMPP可扩展消息与存在协议

Extensible Messaging and Presence Protocol

### 方案考量
#### APNS
（Apple Push Notification Service）和GCM（Google Cloud Messaging）
APNS和GCM是iOS和Android两大阵营提出的官方推送方案，这两者的技术架构较为相似。都是由系统来统一的维护一个长连接，所有的APP统一发送心跳和接收推送。

APNS使用的方便性毋庸置疑，但是GCM却在国内举步维艰，具体原因有以下三个：
1. Google与我国政府交恶，导致GMS（Google Mobile Service）在国内无法正常使用，而GCM是依赖于GMS的，所以无法顺利使用。
1. 由于国内2G和移动3G的NAT超时时间都小于GCM心跳时间(28分钟)，TCP长连接必然无法保活，每次都要等28分钟心跳失败重连后才能收到Push。
1. 某些运营商可能限制了5228端口，移动3G/2G下，发现几乎无法连接上GCM服务器，也就无法获得GCM通知，WhatsApp放后台10分钟后，经常很长时间都收不到Push消息。

#### XMPP
XMPP是一种基于标准通用标记语言的子集XML的协议，它继承了在XML环境中灵活的发展性。因此，基于XMPP的应用具有超强的可扩展性。经过扩展以后的XMPP可以通过发送扩展的信息来处理用户的需求，以及在XMPP的顶端建立如内容发布系统和基于地址的服务等应用程序。而且，XMPP包含了针对服务器端的软件协议，使之能与另一个进行通话，这使得开发者更容易建立客户应用程序或给一个配好系统添加功能。

> 优点

协议成熟，强大，可扩展性强，并且有成熟的开源方案。

> 缺点

信息冗余量大（信息的格式是 XML），因而费流量，费电。

#### MQTT
MQTT全称叫做Message Queuing Telemetry Transport，意为消息队列遥测传输，是IBM开发的一个即时通讯协议。由于其维护一个长连接以轻量级低消耗著称，所以常用于移动端消息推送服务开发。

> 优点

协议简洁轻巧，数据冗余量低。并且支持的设备从智能硬件到智能手机无所不包。
1. 使用发布/订阅消息模式，提供一对多的消息发布和应用程序之间的解耦
1. 消息传输不需要知道负载内容
1. 使用 TCP/IP 提供网络连接
1. 有三种消息发布的服务质量
小型传输，开销很小（固定长度的头部是 2 字节），协议交换最小化，以降低网络流量
使用 Last Will 和 Testament 特性通知有关各方客户端异常中断的机制

> 缺点

服务器端实现难度大，虽然已经有了C++版本的服务端组件，但是并不开源。而且在推送数量较大时如何处理并发是十分考验后台人员的技术水平的。

#### HTTP轮询
HTTP轮询就是在一个给定的时间间隔后，定时向服务器发送请求，查看是否有新的数据。

> 优点

实现简单、可控性强，部署硬件成本低。

> 缺点

1. 实时性差，只有时间到了才会向服务器查看是否有新的数据。
1. 两次请求之间的时间间隔过大，则失去了即时推送的意义。
1. 但如果设置的时间间隔较短的，又会费电费流量。

#### 第三方推送
极光、个推、EMQ

> 优点

集成方便

> 缺点

大量推送数据后，付费服务是在所难免。而且因为是通用共享云，所以你的服务质量是否有保证，也就不能要求太多了，必竟你一毛钱也没出或者也不打算出。


### IM性能考量

> IM的可靠性

1. 心跳机制
1. PingPong机制
1. 断线重连机制
1. QOS机制，消息即时与准确
1. 大文件传输的时候使用分片上传、断点续传、秒传技术等来保证文件的传输

> 安全性

1. 防止 DNS 污染
1. 帐号安全
1. 第三方服务器鉴权
1. 单点登录

> 一些其他的优化
类似微信，服务器不做聊天记录的存储，只在本机进行缓存，这样可以减少对服务端数据的请求，一方面减轻了服务器的压力，另一方面减少客户端流量的消耗。
我们进行http连接的时候尽量采用上层API，类似NSUrlSession。而网络框架尽量使用AFNetWorking3。因为这些上层网络请求都用的是HTTP/2 ，我们请求的时候可以复用这些连接。

> 音视频通话
IM应用中的实时音视频技术，几乎是IM开发中的最后一道高墙。原因在于：实时音视频技术 = 音视频处理技术 + 网络传输技术 的横向技术应用集合体，而公共互联网不是为了实时通信设计的。
实时音视频技术上的实现内容主要包括：音视频的采集、编码、网络传输、解码、播放等环节。

