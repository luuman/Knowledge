## 软件更新

### 难题

> 权限问题：UAC&权限问题

- windows 计划任务（无法交互）
- windows Services（可以交互）
- 不操作管理权限文件、注册表

> 更新体验

- 增量更新
- 自动更新

| 更新方式 |       优点       |                                   缺点 |                   使用场景 |
| -------- | :--------------: | -------------------------------------: | -------------------------: |
| 手动更新 |    简单、稳定    |             繁琐、慢、影响使用、效率低 | 低频更新、降级方案、粘性高 |
| 文件覆盖 |    下载过程块    | 更新慢、实现复杂、稳定性差、写文件失败 |                     打补丁 |
| 自动更新 | 稳定、快、打扰少 |                               实现复杂 |         高频更新、体验要求 |
| 应用商城 |    统一、稳定    |                         受应用商店限制 |           操作系统应用软件 |

### 手动更新

```Mermaid
gantt
  title 手动更新
  section 更新服务
    匹配            :a1, 2016-06-22, 3d
    客户端版本       :a1, 2016-06-22, 0d
    用户信息         :a1, 2016-06-22, 0d
    ...             :a1, 2016-06-22, 0d
  section 检查更新器
    返回             :a1, 2016-06-25, 3d
    包地址            :a1, 2016-06-25, 0d
    版本号            :a1, 2016-06-25, 0d
    更新文案           :a1, 2016-06-25, 0d
  section 更新引导
    提示             :a1, 2016-06-28, 3d
    新功能            :a1, 2016-06-28, 0d
    是否升级           :a1, 2016-06-28, 0d
  section 手动更新
    手动操作           :a1, 2016-06-30, 3d
    跳转浏览器          :a1, 2016-06-30, 0d
    打开安装包覆盖        :a1, 2016-06-30, 0d
```

```Mermaid
gantt
  title 文件覆盖
  section 更新服务
    匹配            :a1, 2016-06-22, 3d
    客户端版本       :a1, 2016-06-22, 0d
    用户信息         :a1, 2016-06-22, 0d
    ...             :a1, 2016-06-22, 0d
  section 检查更新器
    返回             :a1, 2016-06-25, 3d
    包地址            :a1, 2016-06-25, 0d
    版本号            :a1, 2016-06-25, 0d
    更新文案           :a1, 2016-06-25, 0d
  section 更新引导
    提示             :a1, 2016-06-28, 3d
    新功能            :a1, 2016-06-28, 0d
    是否升级           :a1, 2016-06-28, 0d
  section 文件覆盖
    程序操作           :a1, 2016-06-30, 3d
    吊起子程序          :a1, 2016-06-30, 0d
    关闭应用        :a1, 2016-06-30, 0d
    将补丁复制到应用目录        :a1, 2016-06-30, 0d
    重新启动        :a1, 2016-06-30, 0d
```

```Mermaid
gantt
  title 自动更新（后台下载、重启即新）
  section 更新服务
    匹配            :a1, 2016-06-22, 3d
    客户端版本       :a1, 2016-06-22, 0d
    用户信息         :a1, 2016-06-22, 0d
    ...             :a1, 2016-06-22, 0d
  section 检查更新器
      返回             :a1, 2016-06-25, 3d
  section 下载新包
      提示             :a1, 2016-06-28, 3d
  section 重启应用加载新包
      重新启动        :a1, 2016-06-30, 3d
```

```Mermaid
graph TB
    boot --> |启动|v1
    boot --> |重启|v2
    subgraph app
    boot
    end
    subgraph version
    v1 --> |后台下载|v2
    end
```

### 更新

> Web 化

- 将渲染进程（业务）放置在远程 HTTPS
- 优点：更新快、体验极好
- 无法离线使用、主进程更新复杂、多版本兼容问题（壳子与业务之间的版本）
- 场景：重业务、壳子更新少（后台管理系统）

> 文件覆盖

[如何实现 electron 的在线升级热更新功能](https://www.zhangxinxu.com/wordpress/2017/06/how-electron-online-update-hot-fix/)

> 自动更新（官方）

- 基于 Squirrel 框架完成自动更新

> Electron-update

[与官网对比](https://www.electron.build/auto-update.htmlhttps://www.electron.build/auto-update.html)

优点：接入简单、windows 支持签名验证、支持进度条、

缺点： windows 更新体验没有内置的好、存在权限问题

### 增量更新

增量更新：只更新需要更新的地方，增量包（差分包、补丁包）：新旧包的差异包。

增量技术：

- bsdiff/bspatch：使用二进制文件、开源、免费、广泛使用（尤其移动端）
- Xdelta3：适用二进制
- Courgette：谷歌提出，bspatch 优化版本
- RTpatch：商业付费

[对比参考](https://www.shangyexin.com/2018/09/28/delta_algorithm/)

### 灰度发布

根据一定规则发布：用户特征、客户端特征、
